---
import BaseLayout from "../layouts/BaseLayout.astro";
import Hero from "../components/features/home/Hero.astro";
import Skills from "../components/features/home/Skills.astro";
import About from "../components/features/home/About.astro";
import Experience from "../components/features/home/Experience.astro";
import Projects from "../components/features/home/Projects.astro";
import BlogCard from "../components/features/home/BlogCard.astro";
import BadriHeroImage from "../assets/images/badri-arthero.webp";
import { getImage } from "astro:assets";

const blurPlaceholder = await getImage({
  src: BadriHeroImage,
  width: 50,
  quality: 50,
  format: "webp",
});
---

<BaseLayout heroImage={BadriHeroImage}>
  <Hero placeholder={blurPlaceholder.src} />
  <Skills />
  <Experience />
  <Projects />
  <BlogCard home="true" />
  <About />
</BaseLayout>

<script>
  async function initAnimations() {
    const [{ gsap }, { ScrollTrigger }, { ScrollToPlugin }] = await Promise.all(
      [
        import("gsap"),
        import("gsap/ScrollTrigger"),
        import("gsap/ScrollToPlugin"),
      ],
    );

    gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

    // Scroll Animations for elements with .animate-on-scroll
    const animateElements = document.querySelectorAll(".animate-on-scroll");
    animateElements.forEach((element) => {
      gsap.to(element, {
        scrollTrigger: {
          trigger: element,
          start: "top 85%",
          toggleActions: "play none none reverse",
        },
        y: 0,
        opacity: 1,
        duration: 0.6,
        ease: "power3.out",
      });
    });

    // Smooth scroll for anchors
    const anchors = document.querySelectorAll('a[href^="#"]');
    anchors.forEach((anchor) => {
      anchor.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = (e.currentTarget as HTMLAnchorElement).getAttribute(
          "href",
        );
        if (!targetId || targetId === "#") return;
        const targetElement = document.querySelector(targetId);
        if (targetElement) {
          gsap.to(window, {
            duration: 1,
            scrollTo: { y: targetElement, offsetY: 80 },
            ease: "power2.inOut",
          });
        }
      });
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      setTimeout(initAnimations, 100);
    });
  } else {
    // defer even more if already loaded
    if ("requestIdleCallback" in window) {
      requestIdleCallback(() => initAnimations());
    } else {
      setTimeout(initAnimations, 200);
    }
  }
</script>
