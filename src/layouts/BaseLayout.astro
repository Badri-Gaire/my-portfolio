---
import { siteConfig } from "../utils/siteConfig";
import "../styles/globals.css";
import Navbar from "../components/layout/Navbar.astro";
import Footer from "../components/layout/Footer.astro";
import Seo from "../components/shared/Seo.astro";
import ScrollToTop from "../components/ui/buttons/ScrollToTop.astro";
import { getImage } from "astro:assets";

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: "website" | "article";
  publishDate?: Date;
  heroImage: ImageMetadata;
  placeholder?: string;
}

const {
  title = siteConfig.title,
  description = siteConfig.description,
  image,
  type,
  publishDate,
  heroImage,
} = Astro.props;

let optimizedSrc: string | undefined;

if (heroImage) {
  const optimized = await getImage({
    src: heroImage,
    width: 768,
    format: "webp",
    placeholder: "blur",
  });
  optimizedSrc = optimized.src;
}
---

<html lang={siteConfig.lang} class="dark" dir="ltr">
  <head>
    <Seo
      title={title}
      description={description}
      image={image}
      type={type}
      publishDate={publishDate}
    />
    <link rel="preconnect" href="https://www.googletagmanager.com" />
    <link rel="preconnect" href="https://www.google-analytics.com" />
    <!-- Preload image -->
    {
      heroImage && (
        <link
          rel="preload"
          as="image"
          href={optimizedSrc}
          type="image/webp"
          fetchpriority="high"
        />
      )
    }

    <!-- is:inline	Prevents Astro from bundling the CSS.	Eliminates "Render Blocking" CSS requests. -->
    <style is:inline>
      /* Immediate rendering for the body and headers to prevent white screens */
      body,
      h1,
      h2,
      h3,
      .text-size35 {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Oxygen,
          Ubuntu,
          Cantarell,
          "Open Sans",
          "Helvetica Neue",
          sans-serif;
      }
      /* Prevent layout shift during font loading */
      body {
        font-display: swap;
      }

      /* Optional: Add smooth scroll behavior */
      html {
        scroll-behavior: smooth;
      }
    </style>

    <!-- Defer non-critical scripts -->
    <script is:inline define:vars={{ gaId: siteConfig.gaId }}>
      function loadGA() {
        const script = document.createElement("script");
        script.async = true;
        script.src = `https://www.googletagmanager.com/gtag/js?id=${gaId}`;
        document.head.appendChild(script);

        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag("js", new Date());
        gtag("config", gaId);
      }

      if ("requestIdleCallback" in window) {
        requestIdleCallback(() => {
          setTimeout(loadGA, 1000);
        });
      } else {
        window.addEventListener("load", () => {
          setTimeout(loadGA, 2000);
        });
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" /><link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    /><link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Albert+Sans:ital,wght@0,700;1,700&family=Quicksand:wght@300..700&display=swap"
      media="print"
      onload="this.onload=null;this.setAttribute('media', 'all')"
    /></head
  >

  <noscript>
    <link
      href="https://fonts.googleapis.com/css2?family=Albert+Sans:ital,wght@0,700;1,700&family=Quicksand:wght@300..700&display=swap"
      rel="stylesheet"
    />
  </noscript>

  <body class="bg-background text-foreground flex flex-col min-h-screen">
    <!-- Navbar all tabs -->
    <Navbar />
    <!-- Main content pages -->
    <main class="grow container mx-auto px-4">
      <slot />
    </main>
    <!-- Footer sections -->
    <Footer />
    <!-- Button for navigation on top -->
    <ScrollToTop />
    <!-- For PWA -->
    <script>
      import { registerSW } from "virtual:pwa-register";
      // Register service worker after page load to prevent blocking the critical path
      registerSW({
        immediate: false,
        onRegisteredSW(
          swUrl: string,
          r: ServiceWorkerRegistration | undefined,
        ) {
          console.log(`Service Worker at: ${swUrl}`);
        },
        onRegisterError(error: any) {
          console.log("SW registration error", error);
        },
      });
    </script>
  </body>
</html>
